---
layout: null
---
{%- assign studies = site.studies -%}
{%- assign projects = site.projects -%}
{%- assign obsidian = site.obsidian -%}
{%- assign all_docs = studies | concat: projects | concat: obsidian -%}

{%- assign study_archives_temp = "" -%}
{%- for doc in studies -%}
  {%- assign relative_path = doc.path | remove_first: "_studies/" -%}
  {%- if relative_path contains "/" -%}
    {%- assign path_parts = relative_path | split: "/" -%}
    {%- assign archive_name = path_parts.first -%}
    {%- assign study_archives_temp = study_archives_temp | append: archive_name | append: "," -%}
  {%- endif -%}
{%- endfor -%}
{%- assign study_archives = study_archives_temp | split: "," -%}

{%- assign project_archives_temp = "" -%}
{%- for doc in projects -%}
  {%- assign relative_path = doc.path | remove_first: "_projects/" -%}
  {%- if relative_path contains "/" -%}
    {%- assign path_parts = relative_path | split: "/" -%}
    {%- assign archive_name = path_parts.first -%}
    {%- assign project_archives_temp = project_archives_temp | append: archive_name | append: "," -%}
  {%- endif -%}
{%- endfor -%}
{%- assign project_archives = project_archives_temp | split: "," -%}

{%- assign obsidian_archives_temp = "" -%}
{%- for doc in obsidian -%}
  {%- assign relative_path = doc.path | remove_first: "_obsidian/" -%}
  {%- if relative_path contains "/" -%}
    {%- assign path_parts = relative_path | split: "/" -%}
    {%- assign archive_name = path_parts.first -%}
    {%- assign obsidian_archives_temp = obsidian_archives_temp | append: archive_name | append: "," -%}
  {%- endif -%}
{%- endfor -%}
{%- assign obsidian_archives = obsidian_archives_temp | split: "," -%}

{%- assign archives = study_archives | concat: project_archives | concat: obsidian_archives | uniq | compact -%}

{
  "archives": {{ archives | jsonify }},
  "documents": {
    {%- assign processed_docs = "" | split: "" -%}
    {%- for doc in all_docs -%}
      {%- assign collection_path = "_" | append: doc.collection | append: "/" -%}
      {%- assign relative_path = doc.path | remove_first: collection_path -%}
      {%- assign archive_name = "" -%}
      {%- if relative_path contains "/" -%}
        {%- assign path_parts = relative_path | split: "/" -%}
        {%- assign archive_name = path_parts.first -%}
        {%- assign processed_docs = processed_docs | push: doc -%}
      {%- endif -%}
    {%- endfor -%}

    {%- for doc in processed_docs -%}
      {%- assign doc_id = doc.url | jsonify -%}
      {%- assign content_parts = doc.content | split: '[[' -%}
      {%- assign links = "" -%}
      {%- for part in content_parts offset: 1 -%}
        {%- assign link_title = part | split: ']]' | first | strip -%}
        {%- if link_title != "" -%}
          {%- for target_doc in all_docs -%}
            {%- if target_doc.title == link_title -%}
              {%- assign link_id = target_doc.url | jsonify -%}
              {%- assign links = links | append: link_id | append: "," -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
      {%- assign final_links = links | remove_last: "," | split: "," -%}

      {%- assign collection_path = "_" | append: doc.collection | append: "/" -%}
      {%- assign relative_path = doc.path | remove_first: collection_path -%}
      {%- assign path_parts = relative_path | split: "/" -%}
      {%- assign archive_name = path_parts.first -%}

      {{ doc_id }}: {
        "title": {{ doc.title | jsonify }},
        "url": {{ doc.url | relative_url | jsonify }},
        "archive": {{ archive_name | jsonify }},
        "content": {{ doc.content | jsonify }},
        "links": {{ final_links | jsonify }}
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  }
}